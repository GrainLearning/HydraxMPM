"""Unit tests for the cubic shape functions."""

import jax.numpy as jnp
import numpy as np

import pymudokon as pm


def test_create():
    """Test creation of cubic shape function."""
    shapefunction = pm.CubicShapeFunction.create(num_particles=2, dim=2)

    assert isinstance(shapefunction, pm.CubicShapeFunction)

    np.testing.assert_allclose(shapefunction.intr_shapef, jnp.zeros(32, dtype=jnp.float32))

    np.testing.assert_allclose(
        shapefunction.intr_shapef_grad,
        jnp.zeros((32, 2), dtype=jnp.float32),
    )


def test_calc_shp_2d():
    """Test the cubic shape function for 2D."""
    positions = jnp.array([[0.45, 0.21], [0.3, 0.4]])

    nodes = pm.Nodes.create(origin=jnp.array([0.0, 0.0]), end=jnp.array([1.0, 1.0]), node_spacing=0.1)

    shapefunction = pm.CubicShapeFunction.create(num_particles=2, dim=2)

    nodes = shapefunction.set_boundary_nodes(nodes)

    shapefunction, _ = shapefunction.calculate_shapefunction(nodes, positions)
    np.testing.assert_allclose(shapefunction.intr_shapef.shape, (32,))

    expected_shapef = [
        2.5312577e-03,
        5.8218818e-02,
        5.8218818e-02,
        2.5312577e-03,
        1.3691000e-02,
        3.1489241e-01,
        3.1489241e-01,
        1.3691000e-02,
        4.6076472e-03,
        1.0597569e-01,
        1.0597569e-01,
        4.6076472e-03,
        3.4694935e-06,
        7.9798207e-05,
        7.9798207e-05,
        3.4694935e-06,
        2.7777765e-02,
        1.1111109e-01,
        2.7777774e-02,
        -1.9868210e-08,
        1.1111109e-01,
        4.4444448e-01,
        1.1111113e-01,
        -7.9472862e-08,
        2.7777774e-02,
        1.1111113e-01,
        2.7777784e-02,
        -1.9868217e-08,
        -1.9868210e-08,
        -7.9472862e-08,
        -1.9868217e-08,
        1.4210855e-14,
    ]

    np.testing.assert_allclose(expected_shapef, shapefunction.intr_shapef)

    np.testing.assert_allclose(jnp.prod(shapefunction.intr_shapef, axis=0), 0)

    expected_shapef_grad = [
        [-1.5187517e-01, -8.4375188e-02],
        [-7.5937581e-01, -1.9406257e00],
        [7.5937581e-01, -1.9406257e00],
        [1.5187517e-01, -8.4375188e-02],
        [-8.2145840e-01, -3.8541708e-02],
        [-4.1072922e00, -8.8645762e-01],
        [4.1072922e00, -8.8645762e-01],
        [8.2145840e-01, -3.8541708e-02],
        [-2.7645829e-01, 1.2187522e-01],
        [-1.3822916e00, 2.8031249e00],
        [1.3822916e00, 2.8031249e00],
        [2.7645829e-01, 1.2187522e-01],
        [-2.0816922e-04, 1.0416677e-03],
        [-1.0408461e-03, 2.3958312e-02],
        [1.0408461e-03, 2.3958312e-02],
        [2.0816922e-04, 1.0416677e-03],
        [-8.3333313e-01, -8.3333313e-01],
        [-0.0000000e00, -3.3333335e00],
        [8.3333313e-01, -8.3333343e-01],
        [0.0000000e00, 5.9604645e-07],
        [-3.3333335e00, -0.0000000e00],
        [-0.0000000e00, -0.0000000e00],
        [3.3333335e00, -0.0000000e00],
        [0.0000000e00, 0.0000000e00],
        [-8.3333343e-01, 8.3333313e-01],
        [-0.0000000e00, 3.3333335e00],
        [8.3333343e-01, 8.3333343e-01],
        [0.0000000e00, -5.9604645e-07],
        [5.9604645e-07, 0.0000000e00],
        [0.0000000e00, 0.0000000e00],
        [-5.9604645e-07, 0.0000000e00],
        [-0.0000000e00, -0.0000000e00],
    ]

    np.testing.assert_allclose(expected_shapef_grad, shapefunction.intr_shapef_grad)


def test_calc_shp_3d():
    """Test the cubic shape function for 3D."""
    # only test 1 particle here for clarity
    positions = jnp.array([[0.45, 0.21, 0.1]])

    nodes = pm.Nodes.create(origin=jnp.array([0.0, 0.0, 0.0]), end=jnp.array([1.0, 1.0, 1.0]), node_spacing=0.1)

    shapefunction = pm.CubicShapeFunction.create(num_particles=1, dim=3)

    nodes = shapefunction.set_boundary_nodes(nodes)

    shapefunction, _ = shapefunction.calculate_shapefunction(nodes, positions)
    np.testing.assert_allclose(shapefunction.intr_shapef.shape, (64,))

    expected_shapef = [
        4.2187618e-04,
        1.6875052e-03,
        4.2187632e-04,
        -3.0174943e-10,
        9.7031342e-03,
        3.8812548e-02,
        9.7031379e-03,
        -6.9402240e-09,
        9.7031342e-03,
        3.8812548e-02,
        9.7031379e-03,
        -6.9402240e-09,
        4.2187618e-04,
        1.6875052e-03,
        4.2187632e-04,
        -3.0174943e-10,
        2.2818327e-03,
        9.1273338e-03,
        2.2818337e-03,
        -1.6320943e-09,
        5.2482057e-02,
        2.0992827e-01,
        5.2482076e-02,
        -3.7538101e-08,
        5.2482057e-02,
        2.0992827e-01,
        5.2482076e-02,
        -3.7538101e-08,
        2.2818327e-03,
        9.1273338e-03,
        2.2818337e-03,
        -1.6320943e-09,
        7.6794100e-04,
        3.0717649e-03,
        7.6794130e-04,
        -5.4927435e-10,
        1.7662611e-02,
        7.0650458e-02,
        1.7662616e-02,
        -1.2633286e-08,
        1.7662611e-02,
        7.0650458e-02,
        1.7662616e-02,
        -1.2633286e-08,
        7.6794100e-04,
        3.0717649e-03,
        7.6794130e-04,
        -5.4927435e-10,
        5.7824877e-07,
        2.3129958e-06,
        5.7824900e-07,
        -4.1359586e-13,
        1.3299698e-05,
        5.3198804e-05,
        1.3299703e-05,
        -9.5126875e-12,
        1.3299698e-05,
        5.3198804e-05,
        1.3299703e-05,
        -9.5126875e-12,
        5.7824877e-07,
        2.3129958e-06,
        5.7824900e-07,
        -4.1359586e-13,
    ]

    np.testing.assert_allclose(expected_shapef, shapefunction.intr_shapef)

    np.testing.assert_allclose(jnp.prod(shapefunction.intr_shapef, axis=0), 0)

    expected_shapef_grad = [
        [-2.5312522e-02, -1.4062528e-02, -1.2656288e-02],
        [-1.0125011e-01, -5.6250125e-02, -0.0000000e00],
        [-2.5312532e-02, -1.4062533e-02, 1.2656288e-02],
        [1.8104931e-08, 1.0058306e-08, 0.0000000e00],
        [-1.2656261e-01, -3.2343754e-01, -2.9109409e-01],
        [-5.0625056e-01, -1.2937505e00, -0.0000000e00],
        [-1.2656265e-01, -3.2343766e-01, 2.9109409e-01],
        [9.0524651e-08, 2.3134061e-07, 0.0000000e00],
        [1.2656261e-01, -3.2343754e-01, -2.9109409e-01],
        [5.0625056e-01, -1.2937505e00, -0.0000000e00],
        [1.2656265e-01, -3.2343766e-01, 2.9109409e-01],
        [-9.0524651e-08, 2.3134061e-07, 0.0000000e00],
        [2.5312522e-02, -1.4062528e-02, -1.2656288e-02],
        [1.0125011e-01, -5.6250125e-02, -0.0000000e00],
        [2.5312532e-02, -1.4062533e-02, 1.2656288e-02],
        [-1.8104931e-08, 1.0058306e-08, 0.0000000e00],
        [-1.3690969e-01, -6.4236163e-03, -6.8454996e-02],
        [-5.4763895e-01, -2.5694473e-02, -0.0000000e00],
        [-1.3690975e-01, -6.4236186e-03, 6.8454996e-02],
        [9.7925472e-08, 4.5945296e-09, 0.0000000e00],
        [-6.8454856e-01, -1.4774290e-01, -1.5744621e00],
        [-2.7381949e00, -5.9097177e-01, -0.0000000e00],
        [-6.8454880e-01, -1.4774296e-01, 1.5744621e00],
        [4.8962738e-07, 1.0567398e-07, 0.0000000e00],
        [6.8454856e-01, -1.4774290e-01, -1.5744621e00],
        [2.7381949e00, -5.9097177e-01, -0.0000000e00],
        [6.8454880e-01, -1.4774296e-01, 1.5744621e00],
        [-4.8962738e-07, 1.0567398e-07, 0.0000000e00],
        [1.3690969e-01, -6.4236163e-03, -6.8454996e-02],
        [5.4763895e-01, -2.5694473e-02, -0.0000000e00],
        [1.3690975e-01, -6.4236186e-03, 6.8454996e-02],
        [-9.7925472e-08, 4.5945296e-09, 0.0000000e00],
        [-4.6076372e-02, 2.0312531e-02, -2.3038236e-02],
        [-1.8430553e-01, 8.1250146e-02, -0.0000000e00],
        [-4.6076387e-02, 2.0312538e-02, 2.3038236e-02],
        [3.2956397e-08, -1.4528658e-08, 0.0000000e00],
        [-2.3038188e-01, 4.6718737e-01, -5.2987844e-01],
        [-9.2152774e-01, 1.8687500e00, -0.0000000e00],
        [-2.3038195e-01, 4.6718755e-01, 5.2987844e-01],
        [1.6478199e-07, -3.3415853e-07, 0.0000000e00],
        [2.3038188e-01, 4.6718737e-01, -5.2987844e-01],
        [9.2152774e-01, 1.8687500e00, -0.0000000e00],
        [2.3038195e-01, 4.6718755e-01, 5.2987844e-01],
        [-1.6478199e-07, -3.3415853e-07, 0.0000000e00],
        [4.6076372e-02, 2.0312531e-02, -2.3038236e-02],
        [1.8430553e-01, 8.1250146e-02, -0.0000000e00],
        [4.6076387e-02, 2.0312538e-02, 2.3038236e-02],
        [-3.2956397e-08, -1.4528658e-08, 0.0000000e00],
        [-3.4694862e-05, 1.7361123e-04, -1.7347469e-05],
        [-1.3877949e-04, 6.9444510e-04, -0.0000000e00],
        [-3.4694873e-05, 1.7361129e-04, 1.7347469e-05],
        [2.4815705e-11, -1.2417646e-10, 0.0000000e00],
        [-1.7347431e-04, 3.9930511e-03, -3.9899105e-04],
        [-6.9389743e-04, 1.5972208e-02, -0.0000000e00],
        [-1.7347437e-04, 3.9930525e-03, 3.9899105e-04],
        [1.2407853e-10, -2.8560534e-09, 0.0000000e00],
        [1.7347431e-04, 3.9930511e-03, -3.9899105e-04],
        [6.9389743e-04, 1.5972208e-02, -0.0000000e00],
        [1.7347437e-04, 3.9930525e-03, 3.9899105e-04],
        [-1.2407853e-10, -2.8560534e-09, 0.0000000e00],
        [3.4694862e-05, 1.7361123e-04, -1.7347469e-05],
        [1.3877949e-04, 6.9444510e-04, -0.0000000e00],
        [3.4694873e-05, 1.7361129e-04, 1.7347469e-05],
        [-2.4815705e-11, -1.2417646e-10, 0.0000000e00],
    ]

    np.testing.assert_allclose(expected_shapef_grad, shapefunction.intr_shapef_grad)
